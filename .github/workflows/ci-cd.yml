name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  style-check:
    name: Code Style & Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Run Checkstyle
      run: |
        if [ ! -f checkstyle.xml ]; then
          echo "Creating default checkstyle configuration..."
          cat > checkstyle.xml << 'EOF'
        <?xml version="1.0"?>
        <!DOCTYPE module PUBLIC
          "-//Checkstyle//DTD Checkstyle Configuration 1.3//EN"
          "https://checkstyle.org/dtds/configuration_1_3.dtd">
        <module name="Checker">
          <property name="charset" value="UTF-8"/>
          <property name="severity" value="warning"/>
          <property name="fileExtensions" value="java, properties, xml"/>
          
          <module name="TreeWalker">
            <module name="OuterTypeFilename"/>
            <module name="IllegalTokenText"/>
            <module name="AvoidEscapedUnicodeCharacters"/>
            <module name="LineLength">
              <property name="max" value="120"/>
            </module>
            <module name="AvoidStarImport"/>
            <module name="OneTopLevelClass"/>
            <module name="NoLineWrap"/>
            <module name="EmptyBlock"/>
            <module name="NeedBraces"/>
            <module name="LeftCurly"/>
            <module name="RightCurly"/>
            <module name="WhitespaceAround"/>
            <module name="OneStatementPerLine"/>
            <module name="MultipleVariableDeclarations"/>
            <module name="ArrayTypeStyle"/>
            <module name="MissingSwitchDefault"/>
            <module name="FallThrough"/>
            <module name="UpperEll"/>
            <module name="ModifierOrder"/>
            <module name="EmptyLineSeparator"/>
            <module name="SeparatorWrap"/>
            <module name="PackageName"/>
            <module name="TypeName"/>
            <module name="MemberName"/>
            <module name="ParameterName"/>
            <module name="LocalVariableName"/>
            <module name="ClassTypeParameterName"/>
            <module name="MethodTypeParameterName"/>
            <module name="InterfaceTypeParameterName"/>
            <module name="NoFinalizer"/>
            <module name="GenericWhitespace"/>
            <module name="Indentation"/>
            <module name="AbbreviationAsWordInName"/>
            <module name="OverloadMethodsDeclarationOrder"/>
            <module name="VariableDeclarationUsageDistance"/>
            <module name="CustomImportOrder"/>
            <module name="MethodParamPad"/>
            <module name="ParenPad"/>
            <module name="OperatorWrap"/>
            <module name="AnnotationLocation"/>
            <module name="NonEmptyAtclauseDescription"/>
            <module name="JavadocMethod"/>
            <module name="JavadocType"/>
            <module name="JavadocVariable"/>
            <module name="JavadocStyle"/>
          </module>
        </module>
        EOF
        fi
        ./mvnw checkstyle:check -Dcheckstyle.config.location=checkstyle.xml
        
    - name: Run PMD Static Analysis
      run: ./mvnw pmd:check pmd:cpd-check

    - name: Compile with warnings as errors
      run: ./mvnw compile -Dmaven.compiler.failOnError=true

